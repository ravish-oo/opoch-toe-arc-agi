WO-06 is where “truth becomes a quotient.” We’ll implement **Paige–Tarjan** on the presented test grid with: (1) must-link from S-views + components, then (2) cannot-link splits using **input-only** predicates in a **fixed order**. Receipts and a built-in self-check keep debugging algebraic: a contradiction produces a concrete pixel witness, not a vibe.

---

# WO-06 — Truth Partition Q (Must-Link + Paige–Tarjan with fixed separators)

## Purpose

Compute the **coarsest, proof-consistent partition** (Q) of the **presented test input**:

* Merge by **must-link** equalities proven by S-views and component folds.
* Refine by **cannot-link** (Paige–Tarjan) using only *input-legal* predicates, in a fixed order:
  **input_color ≺ membership_in_Sview_image ≺ parity**.
* Use **conjugated reads of training outputs** only to *check* single-valuedness; never to create a separator.

## Files

* `src/truth.py` (new)
* Uses: `src/sviews.py` (WO-03/04), `src/components.py` (WO-05), `src/morphisms.py` (WO-01), `src/receipts.py` (WO-00-lite)

## Hard rules

* No TODOs, no stubs, no new deps.
* Operate **only** on the **presented test input grid** (after WO-02).
* Deterministic in all iterations: same partition and same receipts regardless of train-pair permutation.
* **Do not** read outputs to define predicates; outputs are used only to **detect contradictions** (color conflicts) via conjugation.

---

## Inputs to this module

Provide to `build_truth_partition(...)`:

* `G_test_presented: List[List[int]]` — the presented test input.
* `sviews: List[SView]` — from `build_sviews(G_test_presented)`, depth≤2, cap≤128 (WO-03/04).
* `components: List[Component]` — from `build_components(G_test_presented)` (WO-05).
* `frames: Dict` — frames from WO-02: `P_test`, `P_out[i]` for each training pair.
* `train_outputs_presented: List[List[List[int]]]` — each training output already **posed** per `P_out[i]` (pose-only). No anchoring on outputs.

> Note: Shape differences across train outputs are OK. For contradiction checks we’ll **conjugate** a test pixel to an output pixel via **TEST→OUT** (WO-01). If the mapped pixel is OOB in that output, **skip** it for that training (no evidence, no contradiction).

---

## API (implement exactly)

```python
from typing import List, Tuple, Dict, Optional, Iterable, Callable

Coord = Tuple[int,int]

class Partition:
    def __init__(self, H: int, W: int, cid_of: List[int]):
        # cid_of is length H*W in row-major; integers [0..k-1]
        self.H, self.W = H, W
        self.cid_of = cid_of

    def classes(self) -> List[List[Coord]]:
        # returns coords per class in deterministic class-id order

def build_truth_partition(
    G_test_presented: List[List[int]],
    sviews: List,                      # from sviews.build_sviews
    components: List,                  # from components.build_components
    frames: Dict[str, object],         # expects frames["P_test"], frames["P_out"][i]
    train_outputs_presented: List[List[List[int]]]
) -> Partition:
    """
    1) Must-link closure via S-views + component fold views.
    2) Paige–Tarjan cannot-link splits using fixed predicate order.
    3) Conjugated reads of training outputs to detect contradictions; skip OOB.
    Returns coarsest consistent partition Q.
    """

# Optional helper (pure):
def check_single_valued(
    part: Partition,
    frames: Dict[str, object],
    train_outputs_presented: List[List[List[int]]]
) -> Tuple[bool, Optional[Dict]]:
    """
    Verify every class has at most one observed output color across all trainings,
    where 'observed' means the TEST→OUT mapping lands in-bounds for that training's output.
    Returns (ok, witness) where witness has {cid, train_idx, coord_out, colors_seen}
    for the first contradiction, else None.
    """
```

---

## Algorithm (deterministic, frozen)

### 1) Must-link (union-find on Ω_test)

* Initialize each pixel ((i,j)) to its own class id in row-major.
* For each **structural S-view** (M) in `sviews` (identity, D4-preserving, residue, translations, compositions):

  * For every (x) with (M(x)) defined, `union(x, M(x))`.
* For each **component fold view** from `component_anchor_views(components)`:

  * For every (x) in the component mask, `union(x, anchor)`.
* Result is the **must-link closure**.

### 2) Cannot-link (Paige–Tarjan with fixed separators)

Iteratively refine until no contradictions remain, using this **splitter precedence**:

1. **input_color**: predicate is the integer color at (x) in `G_test_presented`.
2. **membership_in_Sview_image**: for each S-view-image mask (I) (include component masks and any image sets exported from S-views), predicate is (1_{x \in I}).
3. **parity**: ((i+j) \bmod 2).

**Loop**:

* Scan classes in **ascending class id**.
* For the current class (a), we need to know if it is **single-valued** w.r.t. training outputs:

  * For each training (i):

    * For each (x\in a): compute `coord_out = test_to_out(x, P_test, P_out[i])`.
    * If `coord_out` is **in bounds** for the (i)-th output, record the color (Y_i[coord_out]).
  * Gather all recorded colors across all (i). If this set has **size 0 or 1**, class passes for now.
  * If the set has **≥ 2 distinct** colors (contradiction), **split (a)** by the **first applicable predicate** in the fixed order above that yields at least two non-empty parts. Replace (a) with its parts (class id order is stable, old id reused for first part, new ids appended). Continue PT loop.
* Stop when a full pass over classes yields no split.

**Important**:

* **Outputs never define a predicate.** They only witness contradiction.
* If several predicates could split, use the **first** in the fixed order. If none split (should be rare with these predicates), raise an error with a witness (this means your predicate set is insufficient and belongs to locks).

### 3) Finish and verify

* Build a `Partition` with the final `cid_of`.
* Call `check_single_valued(...)` and assert `ok == True`. If not, raise with its witness (algebraic bug).

---

## Receipts (emit once)

Section: `"truth"`
Payload keys:

```json
{
  "splits": [
    {
      "cid": <old_class_id>,
      "predicate": "input_color" | "sview_image" | "parity",
      "parts": <k>,
      "sizes": [n1, n2, ...],
      "witness": { "train_idx": <t>, "coord_out": [r,c], "colors_seen": [a,b,...] }
    },
    ...
  ],
  "final_classes": <int>,
  "single_valued_ok": true,
  "mustlink_sources": {
    "sviews": <count_applied_edges>,
    "components": <count_applied_edges>
  },
  "examples": { }  // filled only on failure with first counterexample
}
```

* Every recorded split carries the **first** contradiction witness that triggered it (which training, which output pixel, which colors).
* `mustlink_sources` counts are simple edge totals applied during union.

Use `receipts.log("truth", payload)` after success. On failure, include `"examples"` with the minimal counterexample and raise `AssertionError("truth partition failed: <reason>")`.

---

## Built-in self-check (debugging = algebra)

Behind `ARC_SELF_CHECK=1`, run these **synthetic** checks inside a `_self_check_truth()` invoked once from `build_truth_partition(...)` (guarded to run only in dev):

1. **Must-link merges**

   * Make a toy grid with two same-color components and include a translation S-view that maps one onto the other inside overlap; verify the union-find merges as expected (final class count decreases).
   * On mismatch: record first pair `(x, M(x))`, add `examples.case="mustlink"`, raise.

2. **Contradiction witnessed by outputs**

   * Craft two tiny “training outputs” (posed), where a class maps to `(r,c)` with color 1 in train 0 and color 2 in train 1 via TEST→OUT.
   * Verify the class is split by the **first** predicate (`input_color` unless equal).
   * If not, log `witness` and raise `"PT split order failed"`.

3. **OOB skip logic**

   * Build one training output where TEST→OUT lands outside bounds for all pixels of a certain class.
   * Verify **no** contradiction is recorded from that training, and class remains as determined by other evidence (empty set does not force a split).

4. **Determinism under train permutation**

   * Run the full PT twice with reversed order of `train_outputs_presented` and `P_out`.
   * Verify `final_classes` and the `splits` vector (minus train_idx values) are identical; re-attach a normalized `train_idx` to show stability if you like. If they differ, raise `"non-deterministic PT"`.

If any check fails, fill `"examples"` with a concrete pixel and raise. Otherwise, log the `"truth"` receipt.

---

## Acceptance (implementer)

* `build_truth_partition(...)` yields a deterministic `Partition`; `check_single_valued` returns `(True, None)`.
* Receipts show ordered `splits`, `final_classes`, `single_valued_ok=true`.
* With `ARC_SELF_CHECK=1`, the self-check passes.
* Implementer pastes the `"truth"` receipt JSON fragment.

---

## Reviewer (after implementation)

Write post-implementation tests that:

* Verify a known mosaic grid produces multiple must-link merges from residue and translations (check `mustlink_sources.sviews > 0`).
* Verify component fold merges happen (`mustlink_sources.components > 0`) and reduce class count.
* Verify a contradiction across two posed train outputs splits by **input_color** first, then **sview_image**, then **parity**, in that order.
* Verify OOB mappings are skipped and do not create false contradictions.
* Verify reversing training-pair order yields identical partitions and receipts (except `train_idx` fields which you may normalize in the assertion).

---

## Prohibited

* Using any output-derived predicate in PT; outputs are for **witnessing** only.
* Non-deterministic class scan order or predicate order.
* Relying on shape laws here (no size pullback needed in WO-06). TEST→OUT uses frames only; OOB → skip.

---

## Why debugging stays algebraic

* Every split records a **witness** pixel and the conflicting colors that forced the split, so you can reproduce in one line.
* If a class is still multi-valued at the end, `check_single_valued` returns a structured witness and the exact conjugation mapping that failed.
* If must-link is suspicious, `mustlink_sources` counts plus S-views receipts let you replay the exact unions applied.

---

This WO completes **Q**, your truth projector. From here on, every law is proven **on classes** that are already consistent across trainings, so selection cannot paper over contradictions—and any bug reduces to a single counterexample coordinate.
